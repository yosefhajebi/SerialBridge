SerialBridgeService

یک سرویس ساده برای خواندن وزن از ترازو PU850 از طریق پورت سریال و ارائه آن به کلاینت‌های TCP.
این سرویس وزن پایدار را تشخیص می‌دهد و تنها در صورتی که وزن برای یک بازه زمانی مشخص پایدار باشد، آن را ارسال می‌کند.

ویژگی‌ها

خواندن وزن از پورت سریال (COM) با تنظیمات دلخواه

تشخیص وزن پایدار با استفاده از تعداد نمونه و زمان مشخص

ارسال وزن پایدار به کلاینت TCP

تشخیص خطا و Overload ترازو

تنظیم تعداد اعشار (Precision)

پشتیبانی از Auto-Zero

لاگ‌گیری کامل برای اشکال‌زدایی و مانیتورینگ

پیش‌نیازها

.NET Framework 4.5

دستگاه PU850

دسترسی به پورت سریال مناسب (COM)

نصب و اجرای پروژه

پروژه را در Visual Studio 2015+ باز کنید.

تنظیمات SerialPort را بررسی کنید.

پروژه را بیلد کنید و فایل exe تولید شده را اجرا کنید.

استفاده
پیکربندی پورت سریال
پارامتر	توضیح
PortName	نام پورت (مثلاً COM3)
BaudRate	نرخ انتقال داده (مثلاً 9600)
DataBits	تعداد بیت داده (مثلاً 8)
Parity	نوع parity (0=None, 1=Odd, 2=Even)
StopBits	تعداد بیت توقف (1 یا 2)
Handshake	کنترل دسترسی (0=None, 1=RTS, 2=XOnXOff)
SerialUtil serial = new SerialUtil();
serial.ReadCom("COM3", 9600, 8, 0, 1, 0);

خواندن وزن پایدار با Timeout
decimal stableWeight = await serial.ReadStableAsync(20000); // 20 ثانیه
if (stableWeight >= 0)
{
    Console.WriteLine("Stable Weight: " + stableWeight);
}
else
{
    Console.WriteLine("No stable weight detected (timeout).");
}

تنظیم تارا و Precision
serial.SetTare(); // وزن فعلی به عنوان تارا ذخیره می‌شود
serial.ClearTare(); // پاک کردن تارا
serial.SetPrecision(1); // یک رقم اعشار

دریافت رویداد بروزرسانی وزن
serial.WeightUpdated += (sender, e) =>
{
    Console.WriteLine($"Weight Updated: {e.Weight}, Stable={e.Stable}, Error={e.Error}, Overload={e.Overload}");
};

الگوریتم تشخیص وزن پایدار

ترازو به صورت متوالی فریم‌های وزن ارسال می‌کند.

وزن‌های دریافتی در صف نمونه‌ها ذخیره می‌شوند.

اگر تعداد نمونه‌ها ≥ STABLE_SAMPLE_COUNT و تغییر وزن‌ها ≤ STABLE_TOLERANCE باشد و زمان نمونه‌ها ≥ STABLE_TIME_MS:

وزن پایدار شناخته می‌شود.

رویداد WeightUpdated فراخوانی می‌شود.

اگر هیچ وزن پایدار دریافت نشود تا زمان Timeout، مقدار -1 برگردانده می‌شود.

نمودار جریان وزن پایدار
  +----------------+
  | دریافت فریم    |
  +----------------+
           |
           v
  +----------------+
  | ذخیره در نمونه‌ها|
  +----------------+
           |
           v
  +-------------------------+
  | تعداد نمونه‌ها کافی؟    |--No--> بازگشت به دریافت فریم
  +-------------------------+
           |
          Yes
           v
  +-------------------------+
  | اختلاف وزن‌ها ≤ Tolerance? |--No--> نمونه‌ها پاک شود
  +-------------------------+
           |
          Yes
           v
  +-------------------------+
  | زمان ≥ STABLE_TIME_MS?   |--No--> منتظر بمان
  +-------------------------+
           |
          Yes
           v
  +----------------+
  | وزن پایدار!    |
  +----------------+

نکات مهم

مقدار -1 نشان‌دهنده عدم دریافت وزن پایدار است.

اگر دستگاه وزن‌ها را با سرعت بالا ارسال کند، افزایش STABLE_SAMPLE_COUNT و STABLE_TIME_MS پیشنهاد می‌شود.

تمام داده‌های دریافتی با Logger لاگ می‌شوند و برای اشکال‌زدایی قابل بررسی هستند.

Cleanup

بعد از پایان کار با SerialUtil:

serial.Close();
serial.Dispose();

نمونه لاگ
2025-12-17 13:01:49  Serial port opened: COM3
2025-12-17 13:01:49  PU850 FRAME HEX → BB-30-30-30-30-35-30
2025-12-17 13:01:49  Weight parsed: 50
2025-12-17 13:01:59  ReadStableAsync timeout
2025-12-17 13:01:59  Read stable weight -1 from COM3


